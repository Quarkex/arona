#!/usr/bin/env ruby

require 'cgi'
require 'json'
require 'mongo'

cgi = CGI.new

$pwd = File.expand_path(File.dirname(__FILE__))
load $pwd + '/../config.rb'
config($pwd + '/../config.json')

Mongo::Logger.logger.level = ::Logger::FATAL

client = Mongo::Client.new([ $config['mongo_ip'] + ':' + $config['mongo_port'].to_s ], :database => $config['mongo_db'])
db = client.database
collection = client["menus"]
collection.indexes.create_one( { :date => -1 }, unique: false )
collection.indexes.create_one( { "CODMENU" => 1 }, unique: false )
collection.indexes.create_one( { "IDIOMA" => 1 }, unique: false )

def slugify( string )
    string.gsub!(/á/, "a")
    string.gsub!(/é/, "e")
    string.gsub!(/í/, "i")
    string.gsub!(/ó/, "o")
    string.gsub!(/ú/, "u")
    string.gsub!(/ñ/, "n")
    string.gsub!(/[\s]+/, "_")
    string.gsub!(/[^a-z A-Z _ \- 0-9]*/, "")
    string.downcase!
    string
end

doc = {
    "general.actualizarnavegador":         "<p><strong>Please upgrade your web browser. You are using an old or unsupported browser that could have serious security issues and lack some important presentational or functional features</strong>. This website has been designed following <a href='http://www.w3.org/'>W3C (<em>World Wide Web Consortium</em>)</a> standards and your browser doesn't meet currently accepted minimum levels of conformity (in particular <a href='http://www.w3.org/TR/CSS21/'>CSS 2.1</a>). You will enyoy a better browsing experience upgrading your browser. This advice is not particular to this site.</p><p>If you are an Internet Explorer user please upgrade to the <a href='http://www.microsoft.com/windows/ie/'>latest version available</a> (we recommed Internet Explorer 8). If you are using Internet Explorer 6 on Windows 2000 upgrading to a later version isn't an option, in that case we advice you to consider installing a recent version of free browsers available for your platform: <a href='http://getfirefox.com/'>Mozilla FireFox</a>, <a href='http://www.opera.com/'>Opera</a>, <a href='http://www.apple.com/safari/'>Apple Safari</a>, <a href='http://www.google.com/chrome'>Google Chrome</a>.</p>",
    "general.agenda":                      "Agenda",
    "general.albumesFotos":                "Albums potos",
    "general.anterior":                    "&lt;&nbsp;Pr&eacute;c&eacute;dent",
    "general.buscador":                    "Introduire texte &agrave; rechercher",
    "general.buscar":                      "Chercher",
    "general.buscar2":                     "Chercher:",
    "general.canalYouTube":                "Visitez notre site sur {0}",
    "general.compartir":                   "Partager",
    "general.contenidos":                  "&nbsp;contenus",
    "general.contenidosRelacionados":      "Contenus li&eacute;s",
    "general.de":                          "&nbsp;de&nbsp;",
    "general.descargaArchivos":            "T&eacute;l&eacute;chargement d'archives",
    "general.destacamosHoy":               "Sujets d'actualit&eacute;",
    "general.destinoAccesible":            "Destination accessible",
    "general.detenerDiapositiva":          "Arr&ecirc;ter le diaporama",
    "general.documentos":                  "Documents",
    "general.enArona":                     "Aujourd'hui &agrave; Arona:",
    "general.enlacesAdicionales":          "Liens compl&eacute;mentaires",
    "general.fotografias":                 "Photos",
    "general.hoy":                         "Aujourd'hui",
    "general.imagenes":                    "Images",
    "general.inicio":                      "D&eacute;but",
    "general.iniciarDiapositiva":          "D&eacute;marrer le diaporama",
    "general.irGaleria":                   "M&eacute;diath&egrave;que",
    "general.irInicio":                    "Aller &agrave; la page de d&eacute;but",
    "general.irPagina":                    "Aller &agrave; la page",
    "general.irPaginaAnterior":            "Aller &agrave; la page pr&eacute;c&eacute;dente",
    "general.irPaginaSiguiente":           "Aller &agrave; la page suivante",

    "general.manyanaHora":                 "Matin",
    "general.manyanaDia":                  "le lendemain",
    "general.mapaWeb":                     "Carte web",
    "general.menu":                        "Menu",
    "general.noche":                       "soir",
    "general.noEventos":                   "Des &eacute;v&eacute;nements n'ont pas &eacute;t&eacute; trouv&eacute;s pour la date s&eacute;lectionn&eacute;e",
    "general.noResultadosBusqueda":        "Aucun r&eacute;sultat n'a &eacute;t&eacute; obtenu avec la recherche",
    "general.noticias":                    "Pas de nouvelles",
    "general.opcionesAvanzadas":           "Recherche avanc&eacute;e",
    "general.otrosAlbumes":                "Other albums",
    "general.pagina":                      "Page&nbsp;",
    "general.patronato":                   "Bur&ouml; principal de Tourisme",
    "general.reservasOnline":              "R&eacute;servez en ligne",
    "general.resultadosBusqueda":          "R&eacute;sultats de la recherche",
    "general.siguiente":                   "Suivant&nbsp;&gt;",
    "general.sonidos":                     "Sons",
    "general.tarde":                       "Soir",
    "general.verMasImagenes":              "Voir plus d'Images",
    "general.video":                       "Vid&eacute;o",
    "general.visitaPortal":                "Visitez notre site Web du conseil municipal",
    "general.volver":                      "Back",
    "general.web":                         "Web:",
    "general.playas":                      "PLAGES",


    "clima.caption":                       "Pr&eacute;vision m&eacute;t&eacute;orologique &agrave; Arona pour aujourd'hui et les prochains jours.",
    "clima.suministradopor":               "Information fournie par <a href='http://www.aemet.es/fr/portada'>AEMET</a>.",
    "clima.ultimaactualizacion":           "Derni&egrave;re mise &agrave; jour des donn&eacute;es:",
    "clima.pronostico":                    "Pronostic",
    "clima.temperatura":                   "Temp&eacute;rature",
    "clima.temperatura":                   "Temp",

    "clima.med":                           "moy",
    "clima.min":                           "min",
    "clima.max":                           "max",
    "clima.TemperaturaMed":                "Temp&eacute;rature moy.",
    "clima.TemperaturaMin":                "Temp&eacute;rature minimale",
    "clima.TemperaturaMax":                "Temp&eacute;rature maximale",
    "clima.ampliarInfo":                   "&Eacute;largir information m&eacute;t&eacute;orologique",


    "factividad.direccion":                "Adresse:",
    "factividad.duracion":                 "Date:",
    "factividad.hora":                     "Heure",
    "factividad.horario":                  "Horaire:",
    "factividad.lugar":                    "Location:",
    "factividad.organiza":                 "Organis&eacute;:",
    "factividad.otrosdatos":               "D'autres donn&eacute;es d'int&eacute;r&ecirc;t:",
    "factividad.precio":                   "Prix:",
    "factividad.taquilla":                 "Guichet:",
    "factividad.telf":                     "T&eacute;l:",
    "lactividad.archivoEventos":           "Archive des &eacute;v&eacute;nements",
    "lactividad.calendario":               "Calendar",
    "lactividad.eventos":                  "Actualit&eacute;",
    "lactividad.agendaCultural":           "Agenda culturel",
    "lactividad.descargarIcal":            "Calendrier T&eacute;l&eacute;chargez au format iCal",
    "factividad.programaEvento":           "Event calendar",
    "factividad.descripcionEvento":        "Description",
    "factividad.fechaPrograma":            "Date",
    "factividad.lugarPrograma":            "Location",
    "factividad.horaPrograma":             "Time ",
    "factividad.evento":                   "Activity ",




    "fdocumento.autor":                    "Auteur:",
    "fdocumento.entradaVigencia":          "***:",
    "fdocumento.masInformacion":           "Plus d'Information:",
    "fdocumento.medioPublicacion":         "Moyen de publication:",
    "fdocumento.normativaAnterior":        "Previous regulations:",
    "fdocumento.normativaPosterior":       "Later regulations:",
    "fdocumento.versionDocumento":         "Version du document:",


    "flocalizativo.accesibilidad":         "Accessibility",
    "flocalizativo.cierre":                "Fermeture:",
    "flocalizativo.comoLlegar":            "Comment&nbsp;arriver",
    "flocalizativo.correoElectronico":     "E-mail:",
    "flocalizativo.datosContacto":         "CDonn&eacute;es&nbsp;de&nbsp;contact",
    "flocalizativo.direccion":             "Adresse:",
    "flocalizativo.fax":                   "FAX:",
    "flocalizativo.fechaUltimaModif":      "Date&nbsp;derni&egrave;re&nbsp;modification:",
    "flocalizativo.horario":               "Horaire:",
    "flocalizativo.principalesServicios":  "Principaux&nbsp;services",
    "flocalizativo.telf":                  "Tel:",
    "flocalizativo.vacaciones":            "Vacances:",
    "flocalizativo.verMapa":               "Voir&nbsp;carte",
    "flocalizativo.localizarGoogleMaps":   "Localiser&nbsp;sur&nbsp;Google&nbsp;Maps",


    "recursos.nueva_ventana":              "Ce lien sera ouvert dans une nouvelle fen&ecirc;tre",


    "webcams.activarVista24h":             "Mettre en service vue 24 h/ 24",
    "webcams.activarVistaEnVivo":          "Mettre en service en direct",
    "webcams.cargando":                    "En chargement...",
    "webcams.infoActualizacion":           "L'image est mise &agrave; jour toutes les {0} secondes.",
    "webcams.masInfo":                     "Plus d'Information.",
    "webcams.proximoRefresco":             "Prochain rafra&icirc;chissement dans {0} secondes.",
    "webcams.ubicacion":                   "Localisation",
    "webcams.noScript":                    "Javascript non disponible. Le rafra&icirc;chissement de l'image ne peut pas se faire de façon automatique. Merci d'effectuer le rafra&icirc;chissement du contenu de la page avec les contr&ocirc;les de votre navigateur de façon manuelle.",


    "enviaramigo.enviar":                  "Send",
    "enviaramigo.enviarAmigo":             "envoyer &agrave; un ami",
    "enviaramigo.correoDestinatario":      "Courrier du destinataire",
    "enviaramigo.tuNombre":                "Votre nom",
    "enviaramigo.tuCorreo":                "Votre E-mail",
    "enviaramigo.comentarios":             "Commentaires",


    "rss.titulo":                          "Patronato Municipal de Turismo del Ayuntamiento de Arona",
    "rss.descripcion":                     "Pas de nouvelles",
    "rss.suscribete":                      "Suscribete al canal RSS",


    "buzonSugerencias.buzonSugerencias":   "Bo&icirc;te &agrave; id&eacute;es ",
    "buzonSugerencias.nombreApellidos":    "Pr&eacute;nom et Noms",
    "buzonSugerencias.correoElectronico":  "E-Mail",
    "buzonSugerencias.telefono":           "T&eacute;l&eacute;phone",
    "buzonSugerencias.asunto":             "Objet",
    "buzonSugerencias.sugerencias":        "Suggestions",
    "buzonSugerencias.enviar":             "Envoyer",
    "buzonSugerencias.textoIdioma":        "Pour tout commentaire ou toute suggestion, veuillez le r&eacute;diger en anglais",
    "general.titulo":                      "Destino: Arona",
    "pie.ayuntamiento":                    "Ayuntamiento de Arona: arona.org",
    "pie.avisolegal":                      "Aviso Legal",
    "pie.protecciondedatos":               "Protección de datos",
    "pie.indicedecontenidos":              "Índice de contenidos",
    "pie.siguenos":                        "Síguenos: "
}

db_strings = collection.find({"IDIOMA": "es"}, {"CODMENU": 1, "NOMBRE": 1})
db_strings.each do | row |
    dictionary_key = slugify row["NOMBRE"].to_s
    row = collection.find({"IDIOMA": "fr", "CODMENU": row["CODMENU"]}, {"NOMBRE": 1, "RESUMEN": 1})
    if row.first != nil then
        row = row.first
        page_title = row["NOMBRE"].to_s
        page_subtitle = row["RESUMEN"].to_s
        doc["pagina.titulo_" + dictionary_key] = page_title if not doc.has_key? "pagina.titulo_" + dictionary_key unless row["NOMBRE"].to_s == ''
        doc["pagina.subtitulo_" + dictionary_key] = page_subtitle if not doc.has_key? "pagina.subtitulo_" + dictionary_key unless row["RESUMEN"].to_s == ''
    end
end

cgi.out("application/json; charset=utf-8"){ doc.to_json }
